<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake game</title>

  <style>
    #screen {
      border: 10px solid #ccc;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      image-rendering: -moz-crisp-edges;
      width: 400px;
      height: 400px;
    }
  </style>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>

  <div id="enter-game-button" style="display: flex; align-items: center; flex-direction: column;">
    <h1>Change your color</h1>
    <ul style="display: flex; gap: 1rem; padding: 0">
      <li style="display: flex;background-color: red; width: 1.875rem; height: 1.875rem;"></li>
      <li style="display: flex;background-color: blue; width: 1.875rem; height: 1.875rem;"></li>
      <li style="display: flex;background-color: yellow; width: 1.875rem; height: 1.875rem;"></li>
      <li style="display: flex;background-color: orange; width: 1.875rem; height: 1.875rem;"></li>
    </ul>
  </div>

  <div id="canvas-div" style="display: flex; justify-content: center;">
    <canvas id="screen"></canvas>
  </div>

  <div style="display: flex; justify-content: center;">
    <ul id="scoreboard" style="font-size: 1.5em"></ul>
  </div>
  
  <script type="module">
    
    import createKeyboardListener from './keyboard-listener.js'
    import createGame from './game.js'
    import createScreenRenderer   from  './render-screen.js'
    import playScoreSoundEffect from './play-score-sound-effect.js'
    import { addPlayerToScoreBoard, removePlayerFromScoreboard, setupScoreboard, updateScoreboard } from './render-scoreboard.js'
    
    const game = createGame()
    const keyboardListener = createKeyboardListener(document)
    
    const socket = io()
    
    socket.on('connect', () => {
      const playerId = socket.id
      
      const defaultSelectedColor = 'red'
      
      const screen = document.querySelector('#screen')
      const screenRenderer = createScreenRenderer()
      
      screenRenderer.renderScreen(screen, game, requestAnimationFrame, playerId, defaultSelectedColor)
      const lis = document.querySelectorAll('li')
      
      lis.forEach(li => {
        li.addEventListener('click', () => {
          const selectedColor = li.style.backgroundColor

          screenRenderer.renderScreen(screen, game, requestAnimationFrame, playerId, selectedColor)
        })
      })
    })
    
    socket.on('disconnect', () => {
      game.unsubscribeAll()
      keyboardListener.unsubscribeAll()
    })
    
    socket.on('setup', state  => {
      const playerId = socket.id
      game.setState(state)
      
      const scoreboard = document.querySelector('#scoreboard')
      scoreboard.innerHTML = ''

      const players = state.players
      
      const screen = document.querySelector('#screen')
      screen.width = state.screen.width
      screen.height = state.screen.height
      
      keyboardListener.registerPlayerId(playerId)
      keyboardListener.subscribe(game.movePlayer)
      keyboardListener.subscribe(command => {
        socket.emit('move-player', command)
      })

      setupScoreboard(players, playerId)
    })

    socket.on('add-player', command => {
      const playerId = socket.id
      game.addPlayer(command)
    })

    socket.on('remove-player', command => {
      const playerId = socket.id
      game.removePlayer(command)

      removePlayerFromScoreboard(command.playerId)
    })

    socket.on('move-player', command => {
      const playerId = socket.id

      if(playerId !== command.playerId) {
        game.movePlayer(command)
      }
    })

    socket.on('add-fruit', command => {
      game.addFruit(command)
    })

    socket.on('remove-fruit', command => {
      game.removeFruit(command)
    })

    socket.on('new-player-added', ({ newPlayer, newPlayerId }) => {
      const playerId = socket.id

      if(playerId !== newPlayerId) {
        addPlayerToScoreBoard(newPlayer, newPlayerId)
      }
    })

    socket.on('point-incremented', command => {
      const playerId = socket.id
      const player = command.player

      if(playerId !== command.playerId) {
        game.incrementPoint(command)
      } else {
        playScoreSoundEffect(player.points)
      }

      updateScoreboard(player, command.playerId)
      
    })

  </script>
</body>
</html>